<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Learn ta compost ya dingus</title>
    <style>
      .game {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .bins {
        display: flex;
        justify-content: space-around;
        width: 100%;
        margin-top: 100px;
      }

      .bin {
        height: 300px;
        width: 150px;
        background-color: aquamarine;
      }

      .item {
        height: 100px;
        width: 100px;
        background-color: red;
        background-size: contain;
        background-repeat: no-repeat;
      }

      .score,
      .attempted {
        align-self: flex-start;
      }

      .over {
        background-color: green;
      }

      .errorMsg {
        height: 20px;
      }

      #win-modal {
        position: fixed;
        top: 10vh;
        left: 35%;
        display: none;
        background-color: white;
      }

      .show-modal {
        display: block;
      }

      .button {
        background-color: yellow;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="game">
      <div class="score"></div>
      <div class="attempted"></div>
      <div class="item" draggable="true"></div>

      <p class="description"></p>
      <p class="errorMsg"></p>

      <div class="bins">
        <div class="bin trash">trash</div>
        <div class="bin recycle">recycle</div>
        <div class="bin compost">compost</div>
      </div>
    </div>

    <div id="win-modal">
      <p>ok good job, but can you do it again? I dare you.</p>
      <p id="final-score"></p>
      <button onclick="startOver()" class="button">Start Over</button>
    </div>

    <script>
      // Declare Data
      let defaultErr = "I don't like it in there!";
      const items = {
        apple: {
          bin: "compost",
          error: defaultErr,
          image: "images/appleicon.png",
        },
        "paper-plate": {
          bin: "recycle",
          error: "Oops, try again",
          image: "images/paperplateicon.png",
        },
        cardboard: {
          bin: "recycle",
          error:
            "Clean cardboard can be composted, but it is better to recycle it",
          image: "images/cardboardicon.png",
        },
        bones: {
          bin: "trash",
          error: defaultErr,
          image: "images/bone.png",
        },
        meat: {
          bin: "trash",
          error: "oops try again",
          image: "images/meaticon.png",
        },
        fish: {
          bin: "trash",
          error: defaultErr,
          image: "images/fishicon.png",
        },
        "dairy-products": {
          bin: "trash",
          error: defaultErr,
          image: "images/dairyicon.png",
        },
        "fat-oil-and-grease": {
          bin: "trash",
          error: defaultErr,
          image: "images/oilicon.png",
        },
        bread: {
          bin: "compost",
          error: "Oops, try again",
          image: "images/breadicon.png",
        },
        "glossy-paper": {
          bin: "trash",
          error: "Oops, try again",
          image: "images/magazineicon.png",
        },
        "pizza-box": {
          bin: "compost",
          error: "Oops, try again",
          image: "images/pizzaicon.png",
        },
        pasta: {
          bin: "compost",
          error: "Oops, try again",
          image: "images/pastaicon.png",
        },
        eggshells: {
          bin: "compost",
          error: defaultErr,
          image: "images/eggshells.png",
        },
        styrofoam: {
          bin: "trash",
          error: defaultErr,
          image: "images/eggshells.png",
        },
        "plastic-bottles": {
          bin: "recycle",
          error: defaultErr,
          image: "images/eggshells.png",
        },
        "glass-bottles": {
          bin: "recycle",
          error: defaultErr,
          image: "images/eggshells.png",
        },
        "aluminum-cans": {
          bin: "recycle",
          error: defaultErr,
          image: "images/eggshells.png",
        },
      };

      // DOING STUFF

      // Setup current item
      let inPlay = shuffle(Object.keys(items));
      let score = 0;
      let attempted = 0;
      let lastSuccess = false;
      let itemImg = document.querySelectorAll(".item")[0];
      let itemDes = document.querySelectorAll(".description")[0];
      let itemErr = document.querySelectorAll(".errorMsg")[0];
      let scoreEl = document.querySelectorAll(".score")[0];
      let attemptedEl = document.querySelectorAll(".attempted")[0];
      let modal = document.querySelector("#win-modal");

      // GAME LOOP START
      let currentItem = inPlay[0];
      displayItem(items[currentItem], currentItem);
      displayScore();

      // Helper Functions
      function startOver() {
        inPlay = shuffle(Object.keys(items));
        score = 0;
        attempted = 0;
        currentItem = inPlay[0];
        displayItem(items[currentItem], currentItem);
        modal.style.display = "none";
      }

      function displayItem(itemConfig, itemName) {
        itemImg.style.backgroundImage = `url('${itemConfig.image}')`;
        itemDes.innerHTML = toTitleCase(itemName);
      }

      function setNextItem() {
        console.log(inPlay);
        let finishedItem = inPlay.shift();

        if (!lastSuccess) {
          // check if item is not correct
          inPlay.push(finishedItem); // put item on end
        }

        if (inPlay.length > 0) {
          // check if game is over
          currentItem = inPlay[0];
          displayItem(items[currentItem], currentItem);
          console.log("continue playing");
        } else {
          modal.style.display = "block";
          console.log("end game");
        }
      }

      function displayScore() {
        scoreEl.innerHTML = `Score: ${score}`;
        attemptedEl.innerHTML = `Attempts: ${attempted}`;
      }

      function toTitleCase(str) {
        return str
          .split("-")
          .map(function (s) {
            return s.charAt(0).toUpperCase() + s.substr(1);
          })
          .join(" ");
      }

      function shuffle(elements) {
        let shuffledArr = [];
        while (elements.length > 0) {
          let idx = Math.floor(Math.random() * elements.length);
          shuffledArr.push(elements[idx]);
          elements.splice(idx, 1);
        }
        return shuffledArr;
      }

      // Event Handlers
      function handleDragStart(event) {
        itemErr.innerHTML = "";
      }

      function handleDragOver(event) {
        event.preventDefault();
      }

      function handleDrop(event) {
        event.target.classList.remove("over");
        let correctBin = items[currentItem].bin;
        attempted++;
        lastSuccess = event.target.classList.contains(correctBin);
        if (lastSuccess) {
          itemErr.innerHTML = "Hooray!";
          // TODO: itemErr.innerHTML=items[currentItem].success;
          score++;
        } else {
          itemErr.innerHTML = items[currentItem].error;
        }
        displayScore();
        setNextItem();
      }

      function handleDragEnter(event) {
        event.target.classList.add("over");
      }

      function handleDragLeave(event) {
        event.target.classList.remove("over");
      }

      itemImg.addEventListener("dragstart", handleDragStart, false);

      let bins = document.querySelectorAll(".bin");
      for (let bin of bins) {
        bin.addEventListener("dragover", handleDragOver, false);
        bin.addEventListener("dragenter", handleDragEnter, false);
        bin.addEventListener("dragleave", handleDragLeave, false);
        bin.addEventListener("drop", handleDrop, false);
      }
    </script>
  </body>
</html>
